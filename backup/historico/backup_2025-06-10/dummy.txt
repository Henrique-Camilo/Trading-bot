import os
import json
from datetime import datetime

# Diret√≥rio dos relat√≥rios
reports_dir = "reports/historico/"

# Obt√©m a data atual
data_hoje = datetime.now().strftime("%Y-%m-%d")

# Caminhos dos arquivos esperados
json_path = os.path.join(reports_dir, f"{data_hoje}_resumo.json")
txt_path = os.path.join(reports_dir, f"{data_hoje}_resumo.txt")
png_path = os.path.join(reports_dir, f"{data_hoje}_grafico.png")

# Fun√ß√£o de diagn√≥stico
def verificar_arquivos():
    problemas = []

    # Verifica JSON
    if not os.path.exists(json_path):
        problemas.append(f"Arquivo JSON ausente: {json_path}")
    else:
        with open(json_path, "r") as f:
            data = json.load(f)
            if not data or "saldo_final" not in data:
                problemas.append("JSON encontrado, mas vazio ou inv√°lido!")

    # Verifica TXT
    if not os.path.exists(txt_path):
        problemas.append(f"Arquivo TXT ausente: {txt_path}")

    # Verifica PNG
    if not os.path.exists(png_path):
        problemas.append(f"Gr√°fico PNG ausente: {png_path}")

    return problemas

# Executa diagn√≥stico
problemas_encontrados = verificar_arquivos()

if problemas_encontrados:
    print("‚ö†Ô∏è Problemas detectados! ‚ö†Ô∏è")
    for problema in problemas_encontrados:
        print(f"- {problema}")

    print("\nüîß Iniciando reparo autom√°tico...")
    
    # Recria JSON se estiver ausente ou inv√°lido
    if not os.path.exists(json_path) or "saldo_final" not in json.load(open(json_path, "r")):
        relatorio_padrao = {
            "data": data_hoje,
            "sinais_processados": 0,
            "lucro_total": 0,
            "saldo_final": 500,  # Definindo um saldo inicial padr√£o
            "projecao_10k_dias": "‚àû",
            "projecao_100k_dias": "‚àû",
            "projecao_1m_dias": "‚àû"
        }
        with open(json_path, "w") as f:
            json.dump(relatorio_padrao, f, indent=4)
        print("‚úÖ Relat√≥rio JSON reparado!")

    # Recria TXT se estiver ausente
    if not os.path.exists(txt_path):
        with open(txt_path, "w") as f:
            f.write("Relat√≥rio di√°rio n√£o gerado corretamente. Reparo em andamento...\n")
        print("‚úÖ Relat√≥rio TXT reparado!")

    # Notifica sobre PNG ausente (n√£o pode ser recriado sem rodar `relatorio_historico.py`)
    if not os.path.exists(png_path):
        print("‚ö†Ô∏è O gr√°fico PNG precisa ser gerado rodando `relatorio_historico.py` novamente!")

else:
    print("‚úÖ Todos os arquivos est√£o corretos! üöÄ")
